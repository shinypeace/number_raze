<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Числовая Гонка</title>
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@900&family=Montserrat:wght@400;700&family=Lobster&family=Press+Start+2P&family=Caveat&display=swap" rel="stylesheet">
    <style>
        /* Общие стили и темы */
        :root {
            --bg-color: #f0f2f5;
            --text-color: #1a202c;
            --primary-color: #4a90e2;
            --primary-hover: #357abd;
            --modal-bg: rgba(255, 255, 255, 0.9);
            --modal-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            --button-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.1);
            --border-color: #e2e8f0;
        }

        [data-theme="cosmos"] {
            --bg-color: #1a202c;
            --text-color: #edf2f7;
            --primary-color: #00f5d4;
            --primary-hover: #00bfa5;
            --modal-bg: rgba(26, 32, 44, 0.95);
            --modal-shadow: 0 10px 25px rgba(0, 245, 212, 0.2);
            --button-shadow: 0 4px 14px 0 rgba(0, 245, 212, 0.2);
            --border-color: #4a5568;
        }

        [data-theme="nature"] {
            --bg-color: #f0fff4;
            --text-color: #2f3e46;
            --primary-color: #4caf50;
            --primary-hover: #388e3c;
            --modal-bg: rgba(232, 245, 233, 0.95);
            --modal-shadow: 0 10px 25px rgba(47, 62, 70, 0.2);
            --button-shadow: 0 4px 14px 0 rgba(76, 175, 80, 0.3);
            --border-color: #a5d6a7;
        }
        
        [data-theme="retro"] {
            --bg-color: #fdf6e3;
            --text-color: #654f3b;
            --primary-color: #d35400;
            --primary-hover: #a04000;
            --modal-bg: rgba(253, 246, 227, 0.95);
            --modal-shadow: 0 10px 25px rgba(101, 79, 59, 0.2);
            --button-shadow: 0 4px 14px 0 rgba(211, 84, 0, 0.3);
            --border-color: #bfa88b;
        }

        [data-theme="neon"] {
            --bg-color: #0d0221;
            --text-color: #f0f0f0;
            --primary-color: #ff00ff;
            --primary-hover: #c700c7;
            --modal-bg: rgba(13, 2, 33, 0.9);
            --modal-shadow: 0 0 20px #ff00ff, 0 0 30px #ff00ff;
            --button-shadow: 0 0 15px #ff00ff;
            --border-color: #ff00ff;
        }

        html {
            height: -webkit-fill-available;
        }
        
        body {
            height: var(--app-height, 100vh); 
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s, color 0.5s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            margin: 0; 
            /* Запрет выделения текста */
            user-select: none;
            -webkit-user-select: none;
        }

        .screen {
            height: 100%; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-in-out;
            width: 100%;
        }
        
        #main-menu .main-title {
             font-family: 'Roboto', sans-serif;
             font-weight: 900;
             letter-spacing: -0.05em;
             text-shadow: 3px 3px 0 rgba(0,0,0,0.05);
        }

        .main-btn {
            background-color: var(--primary-color);
            color: var(--bg-color);
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s, background-color 0.3s, box-shadow 0.3s;
        }
        .main-btn:hover {
            transform: translateY(-3px);
            background-color: var(--primary-hover);
            box-shadow: 0 7px 20px 0 rgba(0, 0, 0, 0.15);
        }

        .secondary-btn {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        .secondary-btn:hover {
            background-color: var(--primary-color);
            color: var(--bg-color);
        }

        .icon-btn {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            transition: all 0.3s;
        }
        .icon-btn:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--bg-color);
        }
        .icon-btn svg {
            width: 24px;
            height: 24px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 100;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--modal-bg);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: var(--modal-shadow);
            width: 90%;
            max-width: 400px;
            transform: scale(0.9);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        #game-board {
            position: relative;
            width: 100%;
            max-width: 500px;
            max-height: 100%; 
            aspect-ratio: 9 / 16;
            overflow: hidden;
            border-radius: 1.5rem;
            border: 3px solid var(--primary-color);
            background-color: var(--modal-bg);
            box-shadow: var(--modal-shadow);
        }
        
        .number-cell {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: var(--text-color);
        }
        .number-cell.found {
            transform: scale(0) !important;
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        .number-cell:active {
            transform: scale(0.9) !important;
        }

        .sound-toggle-slider {
             background-color: #ccc;
             transition: .4s;
             border-radius: 34px;
        }
        .sound-toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .sound-toggle-slider {
            background-color: var(--primary-color);
        }
        input:checked + .sound-toggle-slider:before {
            transform: translateX(26px);
        }

        .hidden {
            display: none;
        }
        .visually-hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="overflow-hidden" oncontextmenu="return false;">

    <audio id="bg-music" loop src="music.mp3"></audio>

    <!-- Главное меню -->
    <div id="main-menu" class="screen p-4">
        <div class="text-center">
             <h1 class="main-title text-6xl md:text-8xl mb-12">
                Числовая <span class="text-[var(--primary-color)]">Гонка</span>
            </h1>
        </div>
        <div class="flex flex-col space-y-4 w-full max-w-xs">
            <button class="main-btn" onclick="game.startGame('easy')">Легко</button>
            <button class="main-btn" onclick="game.startGame('medium')">Средне</button>
            <button class="main-btn" onclick="game.startGame('hard')">Сложно</button>
            <button class="main-btn" onclick="game.startGame('expert')">Эксперт</button>
            <button class="main-btn secondary-btn" onclick="ui.showScreen('other-games')">Другие игры</button>
        </div>
        <div class="flex space-x-4 mt-12">
            <button class="icon-btn flex justify-center items-center" onclick="ui.showModal('rules-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>
            </button>
            <button class="icon-btn flex justify-center items-center" onclick="ui.showModal('stats-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
            </button>
            <button class="icon-btn flex justify-center items-center" onclick="ui.showModal('settings-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Игровой экран -->
    <div id="game-screen" class="screen p-2 hidden">
        <div class="w-full max-w-[500px] flex justify-between items-center px-2 mb-2 flex-shrink-0">
            <div>
                <span class="text-xl font-bold">Искать:</span>
                <span id="next-number" class="text-3xl font-bold text-[var(--primary-color)]">1</span>
            </div>
            <div id="timer" class="text-3xl font-bold">00:00</div>
            <button class="icon-btn flex justify-center items-center" onclick="game.pauseGame()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-6-13.5v13.5" /></svg>
            </button>
        </div>
        <div class="w-full flex-grow flex items-center justify-center overflow-hidden min-h-0">
             <div id="game-board"></div>
        </div>
    </div>
    
    <!-- Экран "Другие игры" -->
    <div id="other-games-screen" class="screen hidden flex-col items-center justify-center p-4">
        <div class="w-full max-w-sm mx-auto text-center">
            <h1 class="text-3xl font-bold tracking-tight mb-6">Другие игры</h1>
            <div id="other-games-container" class="grid grid-cols-3 gap-x-4 gap-y-5"></div>
            <button onclick="ui.showScreen('main-menu')" class="main-btn w-full mt-6 py-3 px-4 rounded-xl font-semibold text-lg">Назад</button>
        </div>
    </div>

    <!-- Модальное окно - Пауза -->
    <div id="pause-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h2 class="text-4xl font-bold mb-8">Пауза</h2>
            <div class="flex flex-col space-y-4">
                <button class="main-btn" onclick="game.resumeGame()">Продолжить</button>
                <button class="main-btn" onclick="game.restartGame()">Перезапустить</button>
                <button class="main-btn" onclick="game.quitGame()">Главное меню</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно - Победа -->
    <div id="win-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h2 class="text-4xl font-bold mb-4 text-[var(--primary-color)]">Победа!</h2>
            <p class="text-lg mb-1">Ваше время:</p>
            <p id="win-time" class="text-5xl font-bold mb-4">00:00</p>
            <p class="text-lg mb-1">Лучшее время:</p>
            <p id="best-time" class="text-2xl font-bold mb-8">00:00</p>
            <div class="flex flex-col space-y-4">
                <button class="main-btn" onclick="game.restartGame()">Играть снова</button>
                <button class="main-btn" onclick="game.quitGame()">Главное меню</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно - Правила -->
    <div id="rules-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-3xl font-bold mb-4 text-center">Правила Игры</h2>
            <p class="text-lg text-center">
                На игровом поле в случайном порядке разбросаны числа.
                Ваша задача - как можно быстрее найти и нажать на все числа по порядку, начиная с 1.
            </p>
            <button class="main-btn w-full mt-8" onclick="ui.hideAllModals()">Понятно</button>
        </div>
    </div>
    
    <!-- Модальное окно - Статистика -->
    <div id="stats-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-3xl font-bold mb-6 text-center">Статистика</h2>
            <div class="space-y-3">
                <div class="flex justify-between p-3 rounded-lg border-2 border-[var(--border-color)]">
                    <span class="font-bold">Легко:</span><span id="stats-easy">--:--</span>
                </div>
                <div class="flex justify-between p-3 rounded-lg border-2 border-[var(--border-color)]">
                    <span class="font-bold">Средне:</span><span id="stats-medium">--:--</span>
                </div>
                <div class="flex justify-between p-3 rounded-lg border-2 border-[var(--border-color)]">
                    <span class="font-bold">Сложно:</span><span id="stats-hard">--:--</span>
                </div>
                <div class="flex justify-between p-3 rounded-lg border-2 border-[var(--border-color)]">
                    <span class="font-bold">Эксперт:</span><span id="stats-expert">--:--</span>
                </div>
            </div>
             <button class="main-btn w-full mt-8" onclick="ui.hideAllModals()">Закрыть</button>
        </div>
    </div>
    
    <!-- Модальное окно - Настройки -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-3xl font-bold mb-6 text-center">Настройки</h2>
            <div class="space-y-6">
                <div>
                    <h3 class="text-xl font-bold mb-3 text-center">Тема</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button class="p-4 rounded-lg text-lg font-bold border-4" style="background-color: #f0f2f5; border-color: #4a90e2; color: #1a202c;" onclick="ui.setTheme('default')">Светлая</button>
                        <button class="p-4 rounded-lg text-lg font-bold border-4" style="background-color: #1a202c; border-color: #00f5d4; color: #edf2f7;" onclick="ui.setTheme('cosmos')">Космос</button>
                        <button class="p-4 rounded-lg text-lg font-bold border-4" style="background-color: #f0fff4; border-color: #4caf50; color: #2f3e46;" onclick="ui.setTheme('nature')">Природа</button>
                        <button class="p-4 rounded-lg text-lg font-bold border-4" style="background-color: #fdf6e3; border-color: #d35400; color: #654f3b;" onclick="ui.setTheme('retro')">Ретро</button>
                        <button class="p-4 rounded-lg text-lg font-bold border-4 col-span-2" style="background-color: #0d0221; border-color: #ff00ff; color: #f0f0f0;" onclick="ui.setTheme('neon')">Неон</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-3 text-center">Звук</h3>
                    <div class="space-y-4">
                         <div class="flex items-center justify-between text-lg">
                            <label for="music-toggle">Музыка</label>
                            <label for="music-toggle" class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="music-toggle" class="sr-only peer">
                                <div class="w-14 h-8 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-[var(--primary-color)]"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between text-lg">
                            <label for="effects-toggle">Эффекты</label>
                            <label for="effects-toggle" class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="effects-toggle" class="sr-only peer">
                                <div class="w-14 h-8 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-[var(--primary-color)]"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <button class="main-btn w-full mt-8" onclick="ui.hideAllModals()">Закрыть</button>
        </div>
    </div>


    <script>
        const config = {
            difficulties: {
                easy: { maxNumber: 25 },
                medium: { maxNumber: 50 },
                hard: { maxNumber: 75 },
                expert: { maxNumber: 100 },
            },
            fonts: ['Roboto', 'Montserrat', 'Lobster', 'Press Start 2P', 'Caveat'],
        };

        const state = {
            currentNumber: 1,
            maxNumber: 0,
            timerInterval: null,
            startTime: 0,
            paused: false,
            difficulty: 'easy',
        };

        let vkUserId = null;
        let wasMusicPlaying = false;
        
        let gameData = {
            theme: 'default',
            musicMuted: false,
            effectsMuted: false,
            levelsCompletedSinceAd: 0,
            stats: {
                easy: null,
                medium: null,
                hard: null,
                expert: null,
            }
        };

        const elements = {
            screens: {
                'main-menu': document.getElementById('main-menu'),
                'game': document.getElementById('game-screen'),
                'other-games': document.getElementById('other-games-screen'),
            },
            gameBoard: document.getElementById('game-board'),
            nextNumber: document.getElementById('next-number'),
            timer: document.getElementById('timer'),
            modals: {
                pause: document.getElementById('pause-modal'),
                win: document.getElementById('win-modal'),
                rules: document.getElementById('rules-modal'),
                stats: document.getElementById('stats-modal'),
                settings: document.getElementById('settings-modal'),
            },
            winTime: document.getElementById('win-time'),
            bestTime: document.getElementById('best-time'),
            musicToggle: document.getElementById('music-toggle'),
            effectsToggle: document.getElementById('effects-toggle'),
            bgMusic: document.getElementById('bg-music'),
        };

        const sound = {
            clickSynth: null,
            winSynth: null,
            buttonSynth: null,
            isReady: false,
            
            init() {
                if (this.isReady || typeof Tone === 'undefined') return;
                try {
                    Tone.start();
                    // Звук выбора числа (из примера "Пятнашки" - sfxSlide)
                    this.clickSynth = new Tone.Synth({ 
                        oscillator: { type: 'sine' }, 
                        envelope: { attack: 0.001, decay: 0.1, sustain: 0.1, release: 0.1 }, 
                        volume: -18 
                    }).toDestination();
                    
                    // Звук победы
                    this.winSynth = new Tone.PolySynth(Tone.FMSynth, { 
                        harmonicity: 3.01, 
                        modulationIndex: 14, 
                        envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 }, 
                        volume: -10 
                    }).toDestination();

                    // Звук тапа по кнопке (из примера "Пятнашки" - sfxTap)
                    this.buttonSynth = new Tone.FMSynth({ 
                        harmonicity: 8, 
                        modulationIndex: 2, 
                        oscillator: { type: 'sine' }, 
                        envelope: { attack: 0.001, decay: 0.1, sustain: 0.01, release: 0.2 }, 
                        modulation: { type: 'square' }, 
                        modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.2 }, 
                        volume: -18 
                    }).toDestination();

                    this.isReady = true;
                } catch (e) {
                    console.error("Audio context could not be started.", e);
                }
            },

            playClick() {
                if (gameData.effectsMuted || !this.isReady) return;
                this.clickSynth.triggerAttackRelease("A5", "32n", Tone.now());
            },
            
            playWin() {
                if (gameData.effectsMuted || !this.isReady) return;
                const now = Tone.now();
                this.winSynth.triggerAttackRelease("C5", "16n", now);
                this.winSynth.triggerAttackRelease("E5", "16n", now + 0.08);
                this.winSynth.triggerAttackRelease("G5", "16n", now + 0.16);
                this.winSynth.triggerAttackRelease("C6", "16n", now + 0.24);
            },

            playButtonTap() {
                if (gameData.effectsMuted || !this.isReady) return;
                this.buttonSynth.triggerAttackRelease('C5', '8n');
            },
            
            toggleMusic(isMuted) {
                 elements.bgMusic.muted = isMuted;
                 if (!isMuted) {
                     elements.bgMusic.play().catch(e => {});
                 }
            }
        };
        
        function formatTime(totalSeconds) {
            if (totalSeconds === null || totalSeconds === undefined) return '--:--';
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        const ui = {
            showScreen(screenName) {
                Object.values(elements.screens).forEach(s => s.classList.add('hidden'));
                elements.screens[screenName].classList.remove('hidden');
                vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(e => {});
            },

            showModal(modalId) {
                const modal = elements.modals[modalId.replace('-modal', '')];
                if (modalId === 'stats-modal') {
                    this.updateStatsDisplay();
                }
                modal.classList.add('active');
            },

            hideAllModals() {
                Object.values(elements.modals).forEach(modal => modal.classList.remove('active'));
            },

            updateStatsDisplay() {
                document.getElementById('stats-easy').textContent = formatTime(gameData.stats.easy);
                document.getElementById('stats-medium').textContent = formatTime(gameData.stats.medium);
                document.getElementById('stats-hard').textContent = formatTime(gameData.stats.hard);
                document.getElementById('stats-expert').textContent = formatTime(gameData.stats.expert);
            },

            setTheme(themeName) {
                document.documentElement.setAttribute('data-theme', themeName);
                gameData.theme = themeName;
                saveGameData();
            },
            
            updateSoundTogglesUI() {
                elements.musicToggle.checked = !gameData.musicMuted;
                elements.effectsToggle.checked = !gameData.effectsMuted;
                sound.toggleMusic(gameData.musicMuted);
            },
            
            renderOtherGames() {
                const container = document.getElementById('other-games-container');
                container.innerHTML = '';
                const games = [
                    { name: 'Bubble Shooter', appId: 54051411, icon: 'icon1.png' }, { name: 'Тетрис', appId: 54051413, icon: 'icon2.png' },
                    { name: 'Tower Blocks', appId: 53962513, icon: 'icon3.png' }, { name: 'Блок Про', appId: 53936296, icon: 'icon4.png' },
                    { name: 'Филворды', appId: 53867134, icon: 'icon5.png' }, { name: 'Словли', appId: 53861990, icon: 'icon6.png' },
                    { name: 'Brick Balls', appId: 54023580, icon: 'icon7.png' }, { name: '2048', appId: 53965380, icon: 'icon8.png' },
                    { name: 'Color Sort', appId: 54143992, icon: 'icon9.png' }
                ];
                games.forEach(game => {
                    const gameEl = document.createElement('div');
                    gameEl.className = "flex flex-col items-center cursor-pointer group";
                    gameEl.dataset.appId = game.appId;
                    gameEl.innerHTML = `
                        <div class="w-20 h-20 bg-gray-200 dark:bg-gray-700 rounded-3xl mb-2 flex items-center justify-center group-hover:scale-105 transition-transform overflow-hidden">
                           <img src="${game.icon}" alt="${game.name}" class="w-full h-full object-cover">
                        </div>
                        <span class="text-xs font-medium text-center">${game.name}</span>`;
                    container.appendChild(gameEl);
                });
                
                container.addEventListener('click', e => {
                    const gameEl = e.target.closest('[data-app-id]');
                    if (gameEl) vkBridge.send('VKWebAppOpenApp', { app_id: parseInt(gameEl.dataset.appId) });
                });
            }
        };

        async function saveGameData() {
            if (!vkUserId) return;
            const storageKey = `number_race_data_${vkUserId}`;
            try {
                await vkBridge.send('VKWebAppStorageSet', { key: storageKey, value: JSON.stringify(gameData) });
            } catch (error) {
                console.error("VK Storage save failed, using localStorage.", error);
                localStorage.setItem(storageKey, JSON.stringify(gameData));
            }
        }
        
        async function loadGameData() {
            if (!vkUserId) return;
            const storageKey = `number_race_data_${vkUserId}`;
            let loadedData = null;
            try {
                const response = await vkBridge.send('VKWebAppStorageGet', { keys: [storageKey] });
                if (response.keys[0]?.value) loadedData = JSON.parse(response.keys[0].value);
            } catch (error) {
                console.error("VK Storage load failed, using localStorage.", error);
                const localData = localStorage.getItem(storageKey);
                if (localData) loadedData = JSON.parse(localData);
            }
            if (loadedData) {
                gameData = {...gameData, ...loadedData};
            }
        }

        async function showInterstitialAd() {
            gameData.levelsCompletedSinceAd++;
            await saveGameData(); 

            if (gameData.levelsCompletedSinceAd >= 2) {
                try {
                    await vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'interstitial' });
                    gameData.levelsCompletedSinceAd = 0;
                    await saveGameData();
                } catch (e) {
                    console.error("Interstitial Ad Error:", e);
                }
            }
        }

        const game = {
            startGame(difficulty) {
                state.difficulty = difficulty;
                this.reset();
                ui.showScreen('game');
                
                setTimeout(() => {
                    this.generateNumbers();
                    this.startTimer();
                }, 400);
            },

            reset() {
                state.currentNumber = 1;
                state.paused = false;
                elements.gameBoard.innerHTML = '';
                elements.nextNumber.textContent = '1';
                elements.timer.textContent = '00:00';
                clearInterval(state.timerInterval);
            },
            
            restartGame() {
                ui.hideAllModals();
                this.startGame(state.difficulty);
            },
            
            quitGame() {
                ui.hideAllModals();
                ui.showScreen('main-menu');
            },

            generateNumbers() {
                const board = elements.gameBoard;
                const boardWidth = board.clientWidth;
                const boardHeight = board.clientHeight;
                board.innerHTML = '';

                const baseMaxNumber = config.difficulties[state.difficulty].maxNumber;
                const aspectRatio = boardWidth / boardHeight;
                const cols = Math.ceil(Math.sqrt(baseMaxNumber * aspectRatio));
                const rows = Math.ceil(baseMaxNumber / cols);
                
                state.maxNumber = rows * cols;

                const cellWidth = boardWidth / cols;
                const cellHeight = boardHeight / rows;

                const cellIndexes = Array.from({ length: state.maxNumber }, (_, i) => i);
                for (let i = cellIndexes.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cellIndexes[i], cellIndexes[j]] = [cellIndexes[j], cellIndexes[i]];
                }

                for (let i = 1; i <= state.maxNumber; i++) {
                    const cell = document.createElement('div');
                    cell.textContent = i;
                    cell.dataset.number = i;
                    cell.classList.add('number-cell');

                    let sizeModifier = 0.85;
                    if (state.difficulty === 'hard') sizeModifier = 0.8;
                    if (state.difficulty === 'expert') sizeModifier = 0.75;
                    const size = Math.min(cellWidth, cellHeight) * sizeModifier;
                    
                    const gridIndex = cellIndexes[i-1];
                    const col = gridIndex % cols;
                    const row = Math.floor(gridIndex / cols);

                    let baseCellLeft = col * cellWidth;
                    const cellTop = row * cellHeight;
                    
                    if (row % 2 !== 0) {
                        baseCellLeft += cellWidth / 2;
                    }
                    
                    const randomOffsetX = Math.random() * (cellWidth - size);
                    const randomOffsetY = Math.random() * (cellHeight - size);

                    let finalLeft = baseCellLeft + randomOffsetX;

                    if (finalLeft + size > boardWidth) { finalLeft = boardWidth - size; }
                    if (finalLeft < 0) { finalLeft = 0; }

                    cell.style.width = `${size}px`;
                    cell.style.height = `${size}px`;
                    cell.style.left = `${finalLeft}px`;
                    cell.style.top = `${cellTop + randomOffsetY}px`;

                    const randomFont = config.fonts[Math.floor(Math.random() * config.fonts.length)];
                    const randomRotation = Math.random() * 80 - 40;
                    cell.style.fontFamily = randomFont;
                    cell.style.fontSize = `${size * 0.55}px`;
                    cell.style.transform = `rotate(${randomRotation}deg)`;

                    cell.addEventListener('click', this.handleNumberClick.bind(this));
                    board.appendChild(cell);
                }
            },

            handleNumberClick(e) {
                if (state.paused) return;
                const clickedNumber = parseInt(e.target.dataset.number);
                if (navigator.vibrate) navigator.vibrate(50);
                
                if (clickedNumber === state.currentNumber) {
                    sound.playClick();
                    e.target.classList.add('found');
                    state.currentNumber++;
                    
                    if (state.currentNumber > state.maxNumber) {
                        this.win();
                    } else {
                        elements.nextNumber.textContent = state.currentNumber;
                    }
                }
            },

            startTimer() {
                state.startTime = Date.now();
                state.timerInterval = setInterval(() => {
                    if (!state.paused) {
                        const elapsedTime = (Date.now() - state.startTime) / 1000;
                        elements.timer.textContent = formatTime(elapsedTime);
                    }
                }, 200);
            },
            
            stopTimer() {
                clearInterval(state.timerInterval);
                return (Date.now() - state.startTime) / 1000;
            },

            pauseGame() {
                state.paused = true;
                ui.showModal('pause');
            },

            resumeGame() {
                ui.hideAllModals();
                state.paused = false;
            },
            
            async win() {
                const finalTime = this.stopTimer();
                sound.playWin();
                
                if (!gameData.stats[state.difficulty] || finalTime < gameData.stats[state.difficulty]) {
                    gameData.stats[state.difficulty] = finalTime;
                }
                
                await showInterstitialAd();
                
                // Небольшая задержка перед показом окна победы, чтобы избежать багов после рекламы
                setTimeout(() => {
                    elements.winTime.textContent = formatTime(finalTime);
                    elements.bestTime.textContent = formatTime(gameData.stats[state.difficulty]);
                    ui.showModal('win');
                }, 100);
            }
        };

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const setAppHeight = () => {
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
        };
        
        async function init() {
            vkBridge.send('VKWebAppInit');
            
            vkBridge.subscribe(e => {
                if (e.detail.type === 'VKWebAppViewHide') {
                    if (!elements.bgMusic.paused) {
                        wasMusicPlaying = true;
                        elements.bgMusic.pause();
                    }
                }
                if (e.detail.type === 'VKWebAppViewRestore') {
                    if (wasMusicPlaying) {
                       elements.bgMusic.play().catch(e => {});
                    }
                    wasMusicPlaying = false;
                }
            });

            try {
                const user = await vkBridge.send('VKWebAppGetUserInfo');
                vkUserId = user.id;
            } catch (error) {
                console.warn("Could not get VK User ID.", error);
                vkUserId = 'test_user';
            }

            await loadGameData();
            
            setAppHeight(); 
            ui.setTheme(gameData.theme || 'default');
            ui.updateSoundTogglesUI();
            ui.renderOtherGames();
            
            // Start audio context on first user interaction
            document.body.addEventListener('click', () => {
                sound.init();
                if (!gameData.musicMuted) {
                    elements.bgMusic.play().catch(e => {});
                }
            }, { once: true });
            
            // Add sound to all buttons
            document.body.addEventListener('click', (e) => {
                if(e.target.closest('button')) {
                    sound.playButtonTap();
                }
            });

            elements.musicToggle.addEventListener('change', (e) => {
                gameData.musicMuted = !e.target.checked;
                sound.toggleMusic(gameData.musicMuted);
                saveGameData();
            });
            elements.effectsToggle.addEventListener('change', (e) => {
                gameData.effectsMuted = !e.target.checked;
                saveGameData();
            });

            Object.values(elements.modals).forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        const isPauseModal = modal.id === 'pause-modal';
                        if (isPauseModal && state.paused) game.resumeGame();
                        else ui.hideAllModals();
                    }
                });
            });

            window.addEventListener('resize', debounce(() => {
                setAppHeight(); 
                if (!elements.screens.game.classList.contains('hidden')) {
                    game.generateNumbers();
                }
            }, 250));
            
            ui.showScreen('main-menu');
        }
        
        window.onload = init;
    </script>
</body>
</html>


